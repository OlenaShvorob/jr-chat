/**
 * –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
 * - –ü—Ä–æ–∑—Ä–∞—á–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å ‚Äî¬†–≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
 *   –¥–æ–ª–∂–µ–Ω –ø–æ–Ω–∏–º–∞—Ç—å —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º—ã
 *   - –ú–æ–∂–Ω–æ –ª–∏ –ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è?
 *   - –í–∞–ª–∏–¥–Ω–æ –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –æ–Ω –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏ –º–æ–∂–Ω–æ –ª–∏ –µ–≥–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å?
 *   - –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ 
 *    - –Ω–∞—á–∞–ª–∞—Å—å –ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∞?
 *    - –ø—Ä–∏—à–ª–æ –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä? —É–¥–∞—á–Ω–æ –ª–∏?
 *    - [–æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Å–ø–∏—Å–∫–µ]
 * 
 * 1. –Ø –Ω–∞–∂–∞–ª –Ω–∞ –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
 * 2. –ù–∞ —Å–µ—Ä–≤–µ—Ä —É—à–µ–ª POST-–∑–∞–ø—Ä–æ—Å
 * 3. –°–µ—Ä–≤–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∞–ª —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å
 * 4. –í–µ—Ä–Ω—É–ª –º–Ω–µ –æ—Ç–≤–µ—Ç
 * 5. –Ø –æ–±—Ä–∞–±–æ—Ç–∞–ª –æ—Ç–≤–µ—Ç, –ø–æ–Ω—è–ª –µ—Å—Ç—å –ª–∏ –æ—à–∏–±–∫–∞
 * 6. –ï—Å–ª–∏ –Ω–µ—Ç –æ—à–∏–±–∫–∏ ‚Äî¬†–ø–æ–∫–∞–∑–∞–ª —ç—Ç–æ
 * 6.1 –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∞ ‚Äî –ø–æ–∫–∞–∑–∞–ª —ç—Ç–æ
 * 
 * –•–æ—Ä–æ—à–æ –±—ã –¥–∞—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
 * –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
 * 
 * –°–ø–æ—Å–æ–±—ã –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ 
 * 1. –ù–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞—Ç—å
 * 2. –í—Å–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
 *   1. –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–µ –≤–≤–æ–¥–∞ –∏ –∫–Ω–æ–ø–∫—É –∏ –ø–æ–º–µ–Ω—è—Ç—å —Ç–µ–∫—Å—Ç –Ω–∞ –∫–Ω–æ–ø–∫–µ
 *   2. –ï—Å–ª–∏ —É–¥–∞—á–Ω–æ ‚Äî¬†—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∏ –≤–µ—Ä–Ω—É—Ç—å —Ç–µ–∫—Å—Ç –æ–±—Ä–∞—Ç–Ω–æ, –æ—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É –∏ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
 *   3. –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ ‚Äî¬†—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∏ –≤–µ—Ä–Ω—É—Ç—å —Ç–µ–∫—Å—Ç –æ–±—Ä–∞—Ç–Ω–æ, –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å —Ñ–æ—Ä–º—É –∏ –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
 * 3. Optimistic UI
 *   1. –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–∫–µ
 *      –û—á–∏—â–∞–µ—Ç —Ñ–æ—Ä–º—É –∏ –¥–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
 *      –í–Ω–æ–≤—å —Å–æ–∑–¥–∞–Ω–Ω–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é –¥–æ–±–∞–≤–ª—è–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ –µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
 * 
 * 
 * 
 * 
 * –í–≤–æ–¥ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * - [x] –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –∑–∞–¥–∞–Ω–æ - null
 * 
 * - [x] –µ—Å–ª–∏ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —ç–∫—Ä–∞–Ω
 * - [ ] –ø—Ä–∏ –≤–≤–æ–¥–µ –∏–º—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ localStorage
 * - [ ] –≤–≤–µ–¥–µ–Ω–Ω–æ–µ –∏–º—è –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
 * 
 * - –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–µ —Å–ø–∏—Å–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π, –µ—Å–ª–∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å 
 *   –≤–≤–µ–¥–µ–Ω–Ω—ã–º –∏–º–µ–Ω–µ–º, —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–ø—Ä–∞–≤–∞
 */


{
  const USERNAME_REC = "username";

  let username = null;

  const chatContainer = document.querySelector(".messages");
  const usernameContainer = document.querySelector(".username");

  /**
 * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å—ã—Ä—ã–π —Ç–µ–∫—Å—Ç:
 * 1) `–∫–æ–¥` ‚Üí <code>–∫–æ–¥</code>
 * 2) :) ‚Üí üòä
 * 3) :( ‚Üí üòû
 */
  function formatText(raw) {
   return raw
      .replace(/`([^`]+)`/g, (_match, code) => `<code>${code}</code>`)
      .replace(/:\)/g, 'üòä')
      .replace(/:\(/g, 'üòû');
  }

  function renderMessages(messages) {
  // –æ—á–∏—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
  chatContainer.innerHTML = "";

  for (const message of messages) {
    // 1) —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å ISO-–¥–∞—Ç—É –≤ –æ–±—ä–µ–∫—Ç Date
    const dateObj = new Date(message.timestamp);

    // 2) —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã –¥–ª—è —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è (–ø—Ä–∏–º–µ—Ä: "17 May 2025")
    const dateLabel = dateObj.toLocaleDateString("en-GB", {
      day:   "numeric",
      month: "short",
      year:  "numeric"
    });

    // 3) —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è —Å–∞–º–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–ø—Ä–∏–º–µ—Ä: "14:05")
    const time = dateObj.toLocaleTimeString("en-GB", {
      hour:   "2-digit",
      minute: "2-digit"
    });

    // 4) –µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π –º–µ—Å—Å–µ–¥–∂ –Ω–æ–≤–æ–≥–æ –¥–Ω—è ‚Äî –≤—Å—Ç–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
    if (!renderMessages._lastDate || renderMessages._lastDate !== dateObj.toDateString()) {
      const sep = document.createElement("div");
      sep.className = "date-separator";
      sep.textContent = dateLabel;
      chatContainer.appendChild(sep);
      renderMessages._lastDate = dateObj.toDateString();
    }

    // 5) —Å–∞–º–∞ –∫–∞—Ä—Ç–æ—á–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    const messageElement = document.createElement("article");
    messageElement.className = "message";
    messageElement.classList.toggle("message-mine", username === message.username);

    messageElement.innerHTML = `
      <div class="message-header">
        <div class="message-author">${message.username}</div>
        <button class="message-control"></button>
      </div>
      <p class="message-text">${formatText(message.text)}</p>
      <time class="message-time">${time}</time>
    `;

    chatContainer.appendChild(messageElement);
  }
}
  function getMessages(cb) {
    fetch("http://localhost:4000/messages", {
      method: "GET",
    })
      .then(function (messagesResponse) {
        if (messagesResponse.status !== 200) {
          throw new Error("Couldn't get messages from server");
        }

        return messagesResponse.json();
      })
      .then(function (messagesList) {
        renderMessages(messagesList);

        if (typeof cb === "function") {
          cb();
        }
      });
  }

  function scrollToBottom() {
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  function initForm() {
    const formContainer = document.querySelector("#message-form");

    const formTextField = formContainer.querySelector("textarea");
    const formSubmitButton = formContainer.querySelector("button");

    const usernameField = formContainer.querySelector("input[name=username]");
    usernameField.value = username;

    formContainer.onsubmit = function(evt) {
      evt.preventDefault();

      const formData = new FormData(evt.target);

      const messageData = {
        username: formData.get("username"),
        text: formData.get("text"),
      };

      formTextField.disabled = true;
      formSubmitButton.disabled = true;
      formSubmitButton.textContent = "–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è...";

      fetch("http://localhost:4000/messages", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(messageData),
      })
        .then(function(newMessageResponse) {
          if (newMessageResponse.status !== 200) {
            //
          }

          formTextField.disabled = false;
          formTextField.value = "";
          formSubmitButton.disabled = false;
          formSubmitButton.textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å";

          getMessages(scrollToBottom);
        });
    }
  }

  function initChat() {
    // HTTP
    // Request --> Response
    // Polling

    // Websocket
    // Message <--> Message
    getMessages();
    setInterval(getMessages, 3000);
    initForm();

    // –ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–∫—Ä–æ–ª–ª–∏—Ç—å?
    // - –ö–æ–≥–¥–∞ –º—ã —Å–∞–º–∏ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ [–Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]
    // - –ö–æ–≥–¥–∞ –º—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è –≤–Ω–∏–∑—É —Å–ø–∏—Å–∫–∞ –∏ –ø—Ä–∏—à–ª–æ [–Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]
    // - –ö–æ–≥–¥–∞ –º—ã —Ç–æ–ª—å–∫–æ –∑–∞–≥—Ä—É–∑–∏–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É

    // | | | | | | | | | |
    //        | ||  ||| |
  }

  // –§–æ—Ä–º–∞ –º–æ–∂–µ—Ç –∂–∏—Ç—å –≤ –¥–≤—É—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è—Ö ‚Äî –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–∫–∞–∑–∞–Ω–æ –∏ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
  // –Ω–µ –ø–æ–∫–∞–∑–∞–Ω–æ
  // –†–µ–∂–∏–º –∫–æ–≥–¥–∞ –æ–∫–Ω–æ –Ω–µ –ø–æ–∫–∞–∑–∞–Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ø–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ 
  // –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±—ã–ª–æ –≤–≤–µ–¥–µ–Ω–æ
  // –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –Ω–µ–∫–æ–µ–≥–æ –º–æ–¥—É–ª—è, –∫–æ—Ç–æ—Ä—ã–π –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Ä–∞–±–æ—Ç—É
  // —Å DOM, –Ω—É–∂–Ω–æ –æ–ø–∏—Å—ã–≤–∞—Ç—å –Ω–µ —Ç–æ–ª—å–∫–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é, –Ω–æ –∏ "—Ä–∞–∑—Ä—É—à–µ–Ω–∏–µ"
  // —ç—Ç–æ–≥–æ –º–æ–¥—É–ª—è
  function initUsernameForm() {
    const usernameForm = usernameContainer.querySelector("form");

    usernameForm.onsubmit = function(evt) {
      evt.preventDefault();

      const formElement = evt.target;
      const formData = new FormData(formElement);
      const enteredUsername = formData.get("username");

      localStorage.setItem(USERNAME_REC, enteredUsername);

      usernameContainer.close();
      usernameForm.onsubmit = null;

      initApp();
    };

    usernameContainer.showModal();
  }

  // –ú–æ–¥–∞–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
  // –ú–æ–¥–∞–ª—å–Ω–æ—Å—Ç—å ‚Äî –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è
  // –í –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ —Ä–µ–∂–∏–º –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞–ª–∏—á–∏–µ–º username
  // - –µ—Å—Ç—å username ‚Äî —Ä–µ–∂–∏–º —á–∞—Ç–∞
  // - –Ω–µ—Ç username ‚Äî —Ä–µ–∂–∏–º –≤–≤–æ–¥–∞ username
  function initApp() {
    username = localStorage.getItem(USERNAME_REC);

    if (username === null) {
      initUsernameForm();
      return;
    }

    initChat();
  }

  initApp();

  //–ö–Ω–æ–ø–∫–∞ "–í—ã–π—Ç–∏": –æ—á–∏—â–∞–µ–º –∏–º—è –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
  const logoutBtn = document.getElementById("logout");
  if (logoutBtn) {
    logoutBtn.onclick = () => {
      // —É–±–∏—Ä–∞–µ–º –∏–∑ localStorage —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –∏–º—è
      localStorage.removeItem(USERNAME_REC);
      // –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É - –ø–æ–∫–∞–∂–µ—Ç—Å—è —Ñ–æ—Ä–º–∞ –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏
      location.reload();
    }
  }
}
  